<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Wonderio_map_editor</title>
        <style media="screen">
            canvas {
                border: lightskyblue 1px dashed;
            }

            * {
                margin: 0;
            }

        </style>
    </head>
    <body>
        <div class="">
        <canvas id="draw_tile" data-action='draw_tile' width="512" height="480"></canvas>
        </div>
        <div class="gua-inline-block">
            <img src="resources/img/small/block1.png" data-action='change_active_tile' data-id='1'>
            <img src="resources/img/small/block2.png" data-action='change_active_tile' data-id='2'>
            <img src="resources/img/small/block3.png" data-action='change_active_tile' data-id='3'>
            <img src="resources/img/small/block4.png" data-action='change_active_tile' data-id='4'>
            <img src="resources/img/small/block5.png" data-action='change_active_tile' data-id='5'>
        </div>
        <div class="gua-controls">
            <button data-action='change_offset' data-offset='-1024'>-1024</button>
            <button data-action='change_offset' data-offset='-16'>-16</button>
            <button data-action='change_offset' data-offset='16'>+16</button>
            <button data-action='change_offset' data-offset='1024'>1024</button>
            <button data-action='clear_tile' data-selector='#id-canvas-tile'>Clear</button>
        </div>
        <script type="text/javascript">
            /*
                8x8 像素每个图块
                2 bits 每个像素 8 bits = 1 byte
                16 bytes 一个图块


                每页 8X8 个图块  宽高 各 64 像素
            */

            const e = sel => document.querySelector(sel)
            const log = console.log.bind(console)

            const actions = {
                change_active_tile(event) {
                    log('event dataset', event.target.dataset)
                    let id = Number(event.target.dataset.id)
                    // 使用一个全局变量保存状态
                    log('active id', id)
                    window.activeTile = event.target
                },
                draw_tile(event) {
                    let target = event.target
                    log('target', target)
                    let rect = target.getBoundingClientRect()
                    let x = event.clientX - rect.left
                    let y = event.clientY - rect.top
                    let tileSize = 32
                    // i j 算出在 tile 中的第几个
                    let i = Math.floor(x / tileSize)
                    let j = Math.floor(y / tileSize)
                    log('active tile', window.activeTile)
                    let x1 = i * tileSize
                    let y1 = j * tileSize
                    window.context.fillRect(x1, y1, tileSize, tileSize)
                    window.context.drawImage(window.activeTile, x1, y1)
                },
            }

            const tilePosition = (x, y, size) => {
                // i j 算出在 tile 中的第几个
                let i = Math.floor(x / size)
                let j = Math.floor(y / size)
                log('active tile', window.activeTile)
                let x1 = i * size
                let y1 = j * size
                return [x1, y1]
            }

            const drawTileAt = (x, y, size) => {
                let [x1, y1] = tilePosition(x, y, size)
                window.context.fillRect(x1, y1, size, size)
                window.context.drawImage(window.activeTile, x1, y1)

                // FIXME: 暂时这么弄一下
                let tile = Number(window.activeTile.dataset.id)
                let tileSize = 32
                let mx = x1 / tileSize
                let my = y1 / tileSize
                window.map.setTile(mx, my, tile)
            }

            const bindEvents = () => {
                e('body').addEventListener('click', event => {
                    let action = event.target.dataset.action
                    actions[action] && actions[action](event)
                })
                // 拖动事件
                let moving = false
                window.canvas.addEventListener('mousedown', event => {
                    moving = true
                    let x = event.clientX
                    let y = event.clientY
                    let tileSize = 32
                    drawTileAt(x, y, tileSize)
                })
                window.canvas.addEventListener('mousemove', event => {
                    if (moving) {
                        let x = event.clientX
                        let y = event.clientY
                        let tileSize = 32
                        drawTileAt(x, y, tileSize)
                    }
                })
                window.canvas.addEventListener('mouseup', event => {
                    moving = false
                })
            }

            const init = () => {
                window.activeTile = null
                window.canvas = e('canvas')
                log('canvas', window.canvas)
                window.context = window.canvas.getContext('2d')
                window.context.fillStyle = '#5080FF'
                window.context.fillRect(0, 0, 512, 480)
            }

            class Map {
                constructor() {
                    this.height = 15
                    this.width = 20
                    this.tiles = []
                    this.setupTiles()
                }
                setupTiles() {
                    let s = this.height * this.width
                    for (var i = 0; i < s; i++) {
                        this.tiles[i] = 0
                    }
                }
                setTile(i, j, tile) {
                    let index = i * this.height + j
                    this.tiles[index] = tile
                }
                exportJSON() {
                    let s = JSON.stringify(this.tiles)
                    log(s)
                }
            }

            const __main = () => {
                window.map = new Map()
                init()
                bindEvents()
            }

            __main()
        </script>
    </body>
</html>
